import os
import logging
import asyncio
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
from dotenv import load_dotenv

load_dotenv()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

BOT_TOKEN = os.getenv('BOT_TOKEN')

if not BOT_TOKEN:
    raise ValueError("–ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è!")

# –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –ö–õ–ê–í–ò–ê–¢–£–†–ê —Å –º–∞–≥–∏—á–µ—Å–∫–∏–º–∏ –∞—Ä—Ö–µ—Ç–∏–ø–∞–º–∏
MAGIC_KEYBOARD = ReplyKeyboardMarkup([
    ['üßô –ê–†–•–ò–ú–ê–ì', 'üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í'],
    ['üåø –î–£–• –ü–†–ò–†–û–î–´', '‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô'],
    ['üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†', 'üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í'],
    ['üåê –ù–∞—à —Å–∞–π—Ç', 'üîÆ –°–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ']
], resize_keyboard=True, one_time_keyboard=True)

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}


class UserState:
    def __init__(self):
        self.photo_id = None
        self.photo_file = None
        self.selected_archetype = None


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user_id = update.effective_user.id
    user_data[user_id] = UserState()

    await update.message.reply_text(
        'üîÆ **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ WEBI-future –ú–∞–≥–∏—á–µ—Å–∫—É—é –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é!**\n\n'
        '–Ø –æ—Ç–∫—Ä—ã–≤–∞—é –ø–æ—Ä—Ç–∞–ª—ã –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ —Ä–∞—Å–∫—Ä—ã–≤–∞—é —Ç–≤–æ–∏ —Å–∫—Ä—ã—Ç—ã–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –æ–±–ª–∏–∫–∏!\n\n'
        '‚ú® **–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã:**\n'
        '‚Ä¢ üßô –ê–†–•–ò–ú–ê–ì - –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –¥—Ä–µ–≤–Ω–∏—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π\n'
        '‚Ä¢ üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í - –¥—Ä—É–≥ –º–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å—É—â–µ—Å—Ç–≤\n'
        '‚Ä¢ üåø –î–£–• –ü–†–ò–†–û–î–´ - –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ –∂–∏–≤–æ–π –ø—Ä–∏—Ä–æ–¥—ã\n'
        '‚Ä¢ ‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô - –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–≥–Ω–µ–º, –≤–æ–¥–æ–π, –≤–æ–∑–¥—É—Ö–æ–º –∏ –∑–µ–º–ª–µ–π\n'
        '‚Ä¢ üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–† - —Ñ–æ—Ä–º–∞ –∏–∑ —á–∏—Å—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏\n'
        '‚Ä¢ üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í - –º–Ω–æ–≥–æ–ª–∏–∫–∏–π —Ö–∞–º–µ–ª–µ–æ–Ω —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–µ–π\n\n'
        '**–ü—Ä–∏—à–ª–∏ —Å–≤–æ—ë —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏ –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ!**',
        reply_markup=MAGIC_KEYBOARD
    )


async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ"""
    try:
        user_id = update.effective_user.id

        if user_id not in user_data:
            user_data[user_id] = UserState()

        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª —Ñ–æ—Ç–æ
        photo_file = await update.message.photo[-1].get_file()
        user_data[user_id].photo_file = photo_file
        user_data[user_id].photo_id = update.message.photo[-1].file_id

        logger.info(f"–ü–æ–ª—É—á–µ–Ω–æ —Ñ–æ—Ç–æ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

        await update.message.reply_text(
            'üì∏ **–§–æ—Ç–æ –ø—Ä–∏–Ω—è—Ç–æ!** –ú–∞–≥–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –Ω–∞—á–∞–ª—Å—è...\n\n'
            '–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –∞—Ä—Ö–µ—Ç–∏–ø–æ–≤ –¥–ª—è –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è:',
            reply_markup=MAGIC_KEYBOARD
        )

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–æ—Ç–æ: {e}")
        await update.message.reply_text(
            '‚ö†Ô∏è –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–º–µ—Ö–∏! –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ.\n'
            '–ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.',
            reply_markup=MAGIC_KEYBOARD
        )


async def handle_archetype_selection(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –∞—Ä—Ö–µ—Ç–∏–ø–∞"""
    try:
        user_id = update.effective_user.id
        text = update.message.text

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞—à —Å–∞–π—Ç"
        if text == 'üåê –ù–∞—à —Å–∞–π—Ç':
            await update.message.reply_text(
                'üåê **WEBI-future Project**\n\n'
                '–ü–æ—Å–µ—Ç–∏—Ç–µ –Ω–∞—à—É –º–∞–≥–∏—á–µ—Å–∫—É—é –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é:\n'
                'https://prusya.pythonanywhere.com/\n\n'
                '‚ú® _–°–∫–æ—Ä–æ: –µ–¥–∏–Ω–æ–µ –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ!_',
                reply_markup=MAGIC_KEYBOARD
            )
            return

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ"
        if text == 'üîÆ –°–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ':
            import random
            archetypes = [
                'üßô –ê–†–•–ò–ú–ê–ì', 'üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í', 'üåø –î–£–• –ü–†–ò–†–û–î–´',
                '‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô', 'üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†', 'üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í'
            ]
            text = random.choice(archetypes)
            await update.message.reply_text(
                f'üé≤ **–°—É–¥—å–±–∞ –≤—ã–±–∏—Ä–∞–µ—Ç –∑–∞ —Ç–µ–±—è!**\n–í—ã–ø–∞–ª–æ: {text}',
                reply_markup=MAGIC_KEYBOARD
            )

        if user_id not in user_data or not user_data[user_id].photo_file:
            await update.message.reply_text(
                '–°–Ω–∞—á–∞–ª–∞ –ø—Ä–∏—à–ª–∏ –º–Ω–µ —Ñ–æ—Ç–æ –¥–ª—è –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞! üì∏',
                reply_markup=MAGIC_KEYBOARD
            )
            return

        archetype_descriptions = {
            'üßô –ê–†–•–ò–ú–ê–ì': '–∞—Ä—Ö–∏–º–∞–≥–æ–º - –ø–æ–≤–µ–ª–∏—Ç–µ–ª–µ–º –¥—Ä–µ–≤–Ω–∏—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π',
            'üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í': '—Ö—Ä–∞–Ω–∏—Ç–µ–ª–µ–º –¥—Ä–∞–∫–æ–Ω–æ–≤ - –¥—Ä—É–≥–æ–º –º–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Å—É—â–µ—Å—Ç–≤',
            'üåø –î–£–• –ü–†–ò–†–û–î–´': '–¥—É—Ö–æ–º –ø—Ä–∏—Ä–æ–¥—ã - –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ–º –∂–∏–≤–æ–π –ø—Ä–∏—Ä–æ–¥—ã',
            '‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô': '–ø–æ–≤–µ–ª–∏—Ç–µ–ª–µ–º —Å—Ç–∏—Ö–∏–π - –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–æ–º –æ–≥–Ω—è, –≤–æ–¥—ã, –≤–æ–∑–¥—É—Ö–∞ –∏ –∑–µ–º–ª–∏',
            'üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†': '–∫—Ä–∏—Å—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–º –∞–≤–∞—Ç–∞—Ä–æ–º - —Ñ–æ—Ä–º–æ–π –∏–∑ —á–∏—Å—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏',
            'üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í': '–º–∞—Å–∫–æ–π —Ç—ã—Å—è—á–∏ –ª–∏–∫–æ–≤ - –º–Ω–æ–≥–æ–ª–∏–∫–∏–º —Ö–∞–º–µ–ª–µ–æ–Ω–æ–º —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–µ–π'
        }

        selected_description = archetype_descriptions.get(text)
        if not selected_description:
            await update.message.reply_text(
                '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏ –º–∞–≥–∏—á–µ—Å–∫–∏–π –∞—Ä—Ö–µ—Ç–∏–ø –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö –Ω–∏–∂–µ üëá',
                reply_markup=MAGIC_KEYBOARD
            )
            return

        user_data[user_id].selected_archetype = text

        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ä—Ö–µ—Ç–∏–ø–∞
        process_descriptions = {
            'üßô –ê–†–•–ò–ú–ê–ì': [
                "üìñ –ß—Ç–µ–Ω–∏–µ –¥—Ä–µ–≤–Ω–∏—Ö –≥—Ä–∏–º—É–∞—Ä–æ–≤...",
                "üîç –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π...",
                "‚ú® –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–ª—è..."
            ],
            'üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í': [
                "üê≤ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ —Å –¥—Ä–∞–∫–æ–Ω–∞–º–∏...",
                "üèîÔ∏è –ü–æ–∏—Å–∫ –≤ –º–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –≥–æ—Ä–∞—Ö...",
                "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥—Ä–∞–∫–æ–Ω—å–µ–π –∞—É—Ä—ã..."
            ],
            'üåø –î–£–• –ü–†–ò–†–û–î–´': [
                "üå≥ –°–≤—è–∑—å —Å –¥—Ä–µ–≤–Ω–∏–º–∏ –ª–µ—Å–∞–º–∏...",
                "üçÉ –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏—Ä–æ–¥–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π...",
                "üí´ –ü—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –¥—É—Ö–æ–≤ –ø—Ä–∏—Ä–æ–¥—ã..."
            ],
            '‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô': [
                "üå™Ô∏è –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∏—Ö–∏–π...",
                "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π –º–∞–≥–∏–∏...",
                "‚ö° –ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö —Å–∏–ª..."
            ],
            'üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†': [
                "üíé –ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏...",
                "üåà –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤–µ—Ç–æ–≤–æ–≥–æ —Å–ø–µ–∫—Ç—Ä–∞...",
                "‚ú® –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–æ–π –º–∞—Ç—Ä–∏—Ü—ã..."
            ],
            'üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í': [
                "üé≠ –ü–æ–∏—Å–∫ –≤ –º–Ω–æ–≥–æ–º–µ—Ä–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ...",
                "üîÑ –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞ –º–∞—Å–æ–∫ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏...",
                "üí´ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ª–∏—á–Ω–æ—Å—Ç–µ–π..."
            ]
        }

        process_steps = process_descriptions.get(text, [
            "üîÆ –ê–Ω–∞–ª–∏–∑ –º–∞–≥–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª–∞...",
            "‚ú® –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è...",
            "üé≠ –§–∏–Ω–∞–ª—å–Ω–∞—è –º–∞–≥–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞..."
        ])

        # –ü—Ä–æ—Ü–µ—Å—Å –º–∞–≥–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        progress_msg = await update.message.reply_text(
            f'**üîÆ WEBI-future –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ!**\n'
            f'–¶–µ–ª—å: {selected_description}\n\n'
            f'_{process_steps[0]}_'
        )

        await asyncio.sleep(3)
        await progress_msg.edit_text(
            f'**üîÆ WEBI-future –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ!**\n'
            f'–¶–µ–ª—å: {selected_description}\n\n'
            f'_{process_steps[1]}_'
        )

        await asyncio.sleep(3)
        await progress_msg.edit_text(
            f'**üîÆ WEBI-future –∑–∞–ø—É—Å–∫–∞–µ—Ç –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ!**\n'
            f'–¶–µ–ª—å: {selected_description}\n\n'
            f'_{process_steps[2]}_'
        )

        await asyncio.sleep(2)
        await progress_msg.delete()

        # –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–∞–≤–µ—Ä—à–∞—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞—Ä—Ö–µ—Ç–∏–ø–∞
        completion_messages = {
            'üßô –ê–†–•–ò–ú–ê–ì': '–¢–µ–ø–µ—Ä—å —Ç—ã –æ–±–ª–∞–¥–∞–µ—à—å –∑–Ω–∞–Ω–∏–µ–º –¥—Ä–µ–≤–Ω–∏—Ö –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –∏ –º–∞–≥–∏—á–µ—Å–∫–æ–π –º—É–¥—Ä–æ—Å—Ç—å—é! üìñ‚ú®',
            'üêâ –•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í': '–î—Ä–∞–∫–æ–Ω—ã –ø—Ä–∏–∑–Ω–∞–ª–∏ –≤ —Ç–µ–±–µ –¥—Ä—É–≥–∞ –∏ —Ö—Ä–∞–Ω–∏—Ç–µ–ª—è! üê≤üî•',
            'üåø –î–£–• –ü–†–ò–†–û–î–´': '–ü—Ä–∏—Ä–æ–¥–∞ –æ–±—Ä–µ–ª–∞ –≤ —Ç–µ–±–µ —Å–≤–æ—ë –≥–æ–ª–æ—Å –∏ –∑–∞—â–∏—Ç–Ω–∏–∫–∞! üå≥üçÉ',
            '‚ö° –ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô': '–°—Ç–∏—Ö–∏–∏ –ø–æ–∫–æ—Ä–∏–ª–∏—Å—å —Ç–≤–æ–µ–π –≤–æ–ª–µ! –û–≥–æ–Ω—å, –≤–æ–¥–∞, –≤–æ–∑–¥—É—Ö –∏ –∑–µ–º–ª—è —Å–ª—É–∂–∞—Ç —Ç–µ–±–µ! üå™Ô∏èüî•',
            'üíé –ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†': '–¢—ã —Å—Ç–∞–ª –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ–º —á–∏—Å—Ç–æ–π —ç–Ω–µ—Ä–≥–∏–∏ –∏ —Å–≤–µ—Ç–∞! üíéüåà',
            'üé≠ –ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í': '–¢—ã –æ–±—Ä—ë–ª —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –º–µ–Ω—è—Ç—å –æ–±–ª–∏–∫–∏ –º–µ–∂–¥—É —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—è–º–∏! üé≠üîÑ'
        }

        await update.message.reply_text(
            f'**‚ú® –ú–ê–ì–ò–ß–ï–°–ö–û–ï –ü–†–ï–í–†–ê–©–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!**\n\n'
            f'–¢—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª—Å—è –≤ {selected_description}!\n\n'
            f'{completion_messages.get(text, "–ú–∞–≥–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç!")}\n\n'
            f'üöÄ **WEBI-future** –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç–∞–ª—ã –≤ –Ω–æ–≤—ã–µ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏!\n\n'
            f'üîó –ü–æ—Å–µ—Ç–∏ –Ω–∞—à —Å–∞–π—Ç: https://prusya.pythonanywhere.com/\n\n'
            f'–•–æ—á–µ—à—å –∏—Å–ø—ã—Ç–∞—Ç—å –¥—Ä—É–≥–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ? –ü—Ä–∏—Å—ã–ª–∞–π –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ!',
            reply_markup=MAGIC_KEYBOARD
        )

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        user_data[user_id] = UserState()

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞–≥–∏—á–µ—Å–∫–æ–º –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–∏: {e}")
        await update.message.reply_text(
            '‚ö†Ô∏è –ú–∞–≥–∏—á–µ—Å–∫–∏–µ –ø–æ–º–µ—Ö–∏! –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å.\n'
            '–ü–æ–ø—Ä–æ–±—É–π –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —Å –∫–æ–º–∞–Ω–¥—ã /start',
            reply_markup=MAGIC_KEYBOARD
        )


async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    text = update.message.text

    if any(archetype in text for archetype in [
        '–ê–†–•–ò–ú–ê–ì', '–•–†–ê–ù–ò–¢–ï–õ–¨ –î–†–ê–ö–û–ù–û–í', '–î–£–• –ü–†–ò–†–û–î–´',
        '–ü–û–í–ï–õ–ò–¢–ï–õ–¨ –°–¢–ò–•–ò–ô', '–ö–†–ò–°–¢–ê–õ–õ–ò–ß–ï–°–ö–ò–ô –ê–í–ê–¢–ê–†',
        '–ú–ê–°–ö–ê –¢–´–°–Ø–ß–ò –õ–ò–ö–û–í', '–ù–∞—à —Å–∞–π—Ç', '–°–ª—É—á–∞–π–Ω–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ'
    ]):
        await handle_archetype_selection(update, context)
    else:
        await update.message.reply_text(
            'üîÆ **WEBI-future –ú–∞–≥–∏—á–µ—Å–∫–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è** –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–±—è!\n\n'
            '–Ø —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—Å—å –Ω–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ —Å–∫—Ä—ã—Ç—ã—Ö –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –æ–±–ª–∏–∫–æ–≤.\n\n'
            '–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å–≤–æ—ë —Ñ–æ—Ç–æ –∏ –≤—ã–±–µ—Ä–∏ –º–∞–≥–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –∏–∑ –º–µ–Ω—é!',
            reply_markup=MAGIC_KEYBOARD
        )


async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    logger.error(f"Exception while handling an update: {context.error}")


def main():
    print("üîÆ –ó–∞–ø—É—Å–∫ WEBI-future –ú–∞–≥–∏—á–µ—Å–∫–æ–π –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏...")

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    application = (
        Application.builder()
        .token(BOT_TOKEN)
        .post_init(on_startup)
        .post_shutdown(on_shutdown)
        .build()
    )

    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
    application.add_error_handler(error_handler)

    print("‚úÖ WEBI-future –ú–∞–≥–∏—á–µ—Å–∫–∞—è –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—è –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!")

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    application.run_polling(
        allowed_updates=Update.ALL_TYPES,
        drop_pending_updates=True
    )


async def on_startup(app: Application):
    print("üîÑ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")


async def on_shutdown(app: Application):
    print("üîÑ –ë–æ—Ç –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è...")


if __name__ == '__main__':
    main()
